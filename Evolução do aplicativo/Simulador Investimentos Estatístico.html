<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Investimentos - An√°lise Estat√≠stica Avan√ßada</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.2"></script>
    <style>
        :root {
            --color-primary: #2158a5;
            --color-primary-hover: #1a4a8f;
            --color-success: #218014;
            --color-warning: #a84b2f;
            --color-error: #c01547;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-border: #e0e0e0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--color-text);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
            color: var(--color-text);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 88, 165, 0.1);
        }

        .input-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .button-group {
            display: grid;
            gap: 10px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .info-box {
            background: #e8f4f8;
            border-left: 4px solid var(--color-primary);
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--color-border);
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--color-primary);
            word-break: break-word;
        }

        .metric-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }

        .chart-container.small {
            height: 300px;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-surface);
        }

        table thead {
            background: #f9f9f9;
            font-weight: 600;
            font-size: 13px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--color-border);
        }

        table th:first-child,
        table td:first-child {
            text-align: left;
        }

        table tbody tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .stat-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-value {
            color: var(--color-primary);
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∞ Simulador de Investimentos</h1>
            <p>An√°lise Probabil√≠stica Avan√ßada com Monte Carlo e Bootstrap Hist√≥rico</p>
        </div>

        <!-- Main Content -->
        <div class="grid">
            <!-- Painel de Entrada -->
            <div class="card">
                <h2>Par√¢metros da Simula√ß√£o</h2>

                <div class="info-box">
                    ‚ö†Ô∏è <strong>M√©todo:</strong> Bootstrap Hist√≥rico + Distribui√ß√£o Normal param√©trica. Mais realista que Range Rule.
                </div>

                <!-- Capital Inicial -->
                <div class="form-group">
                    <label>Capital Inicial (R$)</label>
                    <div class="input-range">
                        <input type="number" id="capital_inicial" value="1400000" min="10000" step="10000">
                    </div>
                </div>

                <!-- Aporte Mensal -->
                <div class="form-group">
                    <label>Aporte Mensal (R$)</label>
                    <div class="input-range">
                        <input type="number" id="aporte_mensal" value="4500" min="0" step="100">
                    </div>
                </div>

                <!-- Rentabilidade Anual -->
                <div class="form-group">
                    <label>Rentabilidade Anual - M√©dia (%)</label>
                    <input type="number" id="media_retorno" value="12.04" min="-50" max="100" step="0.01">
                </div>

                <div class="form-group">
                    <label>Volatilidade Anual (Desvio Padr√£o, %)</label>
                    <input type="number" id="volatilidade" value="10.79" min="0.1" max="100" step="0.01">
                </div>

                <!-- M√©todo de Simula√ß√£o -->
                <div class="form-group">
                    <label>M√©todo de Simula√ß√£o</label>
                    <select id="metodo_simulacao">
                        <option value="normal">Distribui√ß√£o Normal (Gaussiana)</option>
                        <option value="bootstrap">Bootstrap Hist√≥rico (Recomendado)</option>
                        <option value="t_student">Distribui√ß√£o t-Student (Caudas Pesadas)</option>
                    </select>
                </div>

                <!-- Per√≠odo -->
                <div class="form-group">
                    <label>Per√≠odo (Anos)</label>
                    <input type="number" id="periodo_anos" value="10" min="1" max="50" step="1">
                </div>

                <!-- Meta -->
                <div class="form-group">
                    <label>Meta Final (R$)</label>
                    <input type="number" id="meta_final" value="10000000" min="0" step="100000">
                </div>

                <!-- Simula√ß√µes -->
                <div class="form-group">
                    <label>N√∫mero de Simula√ß√µes</label>
                    <input type="number" id="n_simulacoes" value="10000" min="1000" max="100000" step="1000">
                </div>

                <!-- Bot√µes -->
                <div class="button-group">
                    <button class="btn-primary" onclick="executarSimulacao()">‚ñ∂Ô∏è Executar Simula√ß√£o</button>
                    <button class="btn-secondary" onclick="limparResultados()">üîÑ Limpar</button>
                </div>

                <div id="status_simulacao" style="margin-top: 20px; text-align: center;"></div>
            </div>

            <!-- Resumo de Resultados -->
            <div>
                <div class="results-grid" id="resultados_container" style="display: none;">
                    <div class="metric-card">
                        <div class="metric-label">Saldo Final M√©dio</div>
                        <div class="metric-value" id="saldo_final_medio">-</div>
                        <div class="metric-subtitle" id="saldo_percentual">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Saldo Final Mediano</div>
                        <div class="metric-value" id="saldo_mediano">-</div>
                        <div class="metric-subtitle">50¬∫ Percentil</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Melhor Cen√°rio (95%)</div>
                        <div class="metric-value" id="saldo_maximo">-</div>
                        <div class="metric-subtitle">Otimista</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Pior Cen√°rio (5%)</div>
                        <div class="metric-value" id="saldo_minimo">-</div>
                        <div class="metric-subtitle">Pessimista</div>
                    </div>
                </div>

                <!-- Gr√°fico Principal -->
                <div class="card" style="display: none;" id="chart_card_1">
                    <h2>Evolu√ß√£o do Patrim√¥nio - Simula√ß√µes</h2>
                    <div class="chart-container">
                        <canvas id="chart_evolucao"></canvas>
                    </div>
                </div>

                <!-- Gr√°fico Distribui√ß√£o Final -->
                <div class="card" style="display: none;" id="chart_card_2">
                    <h2>Distribui√ß√£o de Saldos Finais</h2>
                    <div class="chart-container small">
                        <canvas id="chart_distribuicao"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Proje√ß√£o Anual -->
        <div class="card" style="display: none;" id="table_card">
            <h2>Proje√ß√£o Anual Detalhada</h2>
            <div class="table-responsive">
                <table id="tabela_projecao">
                    <thead>
                        <tr>
                            <th>Ano</th>
                            <th>Total Investido</th>
                            <th>Saldo M√©dio</th>
                            <th>Saldo P5 (5%)</th>
                            <th>Saldo P50 (50%)</th>
                            <th>Saldo P95 (95%)</th>
                        </tr>
                    </thead>
                    <tbody id="tabela_body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- An√°lise de Risco -->
        <div class="card" style="display: none;" id="risk_card">
            <h2>üìä An√°lise de Risco</h2>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-label">Probabilidade de Sucesso</div>
                    <div class="stat-value" id="prob_sucesso">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Probabilidade de Ru√≠na</div>
                    <div class="stat-value" id="prob_ruina">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Value at Risk (VaR 95%)</div>
                    <div class="stat-value" id="var_95">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Volatilidade dos Resultados</div>
                    <div class="stat-value" id="volatilidade_resultados">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // MOTOR ESTAT√çSTICO - SIMULADOR DE INVESTIMENTOS COM BOOTSTRAP
        // ============================================================================
        // Este c√≥digo implementa um simulador de investimentos baseado em:
        // 1. Monte Carlo: Amostragem aleat√≥ria para gerar m√∫ltiplos cen√°rios
        // 2. Bootstrap: Reamostragem dos dados hist√≥ricos reais
        // 3. Distribui√ß√£o Normal: Modelo param√©trico com m√©dia e desvio padr√£o
        // 4. Distribui√ß√£o t-Student: Para capturar caudas gordas (eventos extremos)
        // ============================================================================

        // Armazenar dados globais para reutiliza√ß√£o
        let simulacaoAtual = null;
        let chartEvolucao = null;
        let chartDistribuicao = null;

        /**
         * Gera n√∫meros aleat√≥rios com distribui√ß√£o Normal (Box-Muller)
         * @param {number} media - M√©dia da distribui√ß√£o
         * @param {number} desvio_padrao - Desvio padr√£o
         * @returns {number} Valor aleat√≥rio normal
         */
        function gerarNormal(media, desvio_padrao) {
            let u1 = Math.random();
            let u2 = Math.random();
            let z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            return media + z * desvio_padrao;
        }

        /**
         * Gera n√∫mero com distribui√ß√£o t-Student (aproxima√ß√£o)
         * Usa raz√£o de dois normais para simular caudas pesadas
         * @param {number} media
         * @param {number} desvio_padrao
         * @param {number} graus_liberdade
         */
        function gerarTStudent(media, desvio_padrao, graus_liberdade = 5) {
            let chi2 = 0;
            for (let i = 0; i < graus_liberdade; i++) {
                let u = Math.random();
                chi2 += u * u;
            }
            let z = gerarNormal(0, 1);
            let t = z / Math.sqrt(chi2 / graus_liberdade);
            return media + t * desvio_padrao;
        }

        /**
         * Implementa Bootstrap Hist√≥rico
         * Sorteia aleatoriamente, com reposi√ß√£o, retornos passados
         * @param {array} dados_historicos - Retornos hist√≥ricos
         * @returns {number} Retorno sorteado do hist√≥rico
         */
        function bootstrapHistorico(dados_historicos) {
            if (dados_historicos.length === 0) return 0;
            const indice = Math.floor(Math.random() * dados_historicos.length);
            return dados_historicos[indice];
        }

        /**
         * FUN√á√ÉO PRINCIPAL: Executa a simula√ß√£o de Monte Carlo
         * @param {object} parametros - Configura√ß√µes da simula√ß√£o
         */
        function executarMonteCarlo(parametros) {
            const {
                capital_inicial,
                aporte_mensal,
                media_retorno,
                volatilidade,
                periodo_anos,
                n_simulacoes,
                metodo
            } = parametros;

            const meses = periodo_anos * 12;
            const taxa_mensal_media = media_retorno / 12 / 100;
            const taxa_mensal_vol = volatilidade / Math.sqrt(12) / 100;

            // Dados hist√≥ricos (exemplo: seus retornos anuais reais 2017-2025)
            // Para usar seus dados reais, carregue aqui
            const dados_anuais = [0.0566, 0.1263, 0.2926, 0.1035, 0.0147, 0.0140, 0.2070, 0.0139, 0.2551];

            // Array para armazenar resultados de cada simula√ß√£o
            let resultados_finais = [];
            let historico_evolucao = [];

            // Estrutura: historico_evolucao[mes][simulacao] = saldo
            for (let mes = 0; mes <= meses; mes++) {
                historico_evolucao[mes] = [];
            }

            // ========== LOOP PRINCIPAL: N SIMULA√á√ïES ==========
            for (let sim = 0; sim < n_simulacoes; sim++) {
                let saldo = capital_inicial;
                historico_evolucao[0][sim] = saldo;

                // Percorre cada m√™s de simula√ß√£o
                for (let mes = 1; mes <= meses; mes++) {
                    // Gera retorno mensal conforme o m√©todo escolhido
                    let retorno_mensal;

                    if (metodo === 'normal') {
                        // Distribui√ß√£o Normal Gaussiana
                        retorno_mensal = gerarNormal(taxa_mensal_media, taxa_mensal_vol);
                    } else if (metodo === 'bootstrap') {
                        // Bootstrap dos retornos hist√≥ricos convertidos para mensal
                        let retorno_anual = bootstrapHistorico(dados_anuais);
                        retorno_mensal = (Math.pow(1 + retorno_anual, 1/12) - 1);
                    } else if (metodo === 't_student') {
                        // Distribui√ß√£o t-Student (caudas gordas)
                        retorno_mensal = gerarTStudent(taxa_mensal_media, taxa_mensal_vol, 5);
                    }

                    // Aplicar retorno ao saldo e adicionar aporte mensal
                    saldo = saldo * (1 + retorno_mensal) + aporte_mensal;

                    // Armazenar evolu√ß√£o anual (a cada 12 meses)
                    if (mes % 12 === 0 || mes === meses) {
                        historico_evolucao[mes][sim] = saldo;
                    }
                }

                // Armazenar saldo final desta simula√ß√£o
                resultados_finais.push(saldo);
            }

            // ========== AN√ÅLISE ESTAT√çSTICA DOS RESULTADOS ==========

            // Ordenar para encontrar percentis
            resultados_finais.sort((a, b) => a - b);

            // C√°lculos estat√≠sticos
            const saldo_minimo = resultados_finais[Math.floor(n_simulacoes * 0.05)]; // 5¬∫ percentil
            const saldo_mediano = resultados_finais[Math.floor(n_simulacoes * 0.5)]; // Mediana (50¬∫)
            const saldo_medio = resultados_finais.reduce((a, b) => a + b) / n_simulacoes; // M√©dia
            const saldo_maximo = resultados_finais[Math.floor(n_simulacoes * 0.95)]; // 95¬∫ percentil

            // Volatilidade dos resultados
            const variancia = resultados_finais.reduce((acc, val) => acc + Math.pow(val - saldo_medio, 2), 0) / n_simulacoes;
            const desvio_resultados = Math.sqrt(variancia);

            // Contadores para probabilidades
            const meta_final = parametros.meta_final;
            const capital_investido = capital_inicial + (aporte_mensal * meses);
            
            let sucesso = resultados_finais.filter(x => x >= meta_final).length;
            let ruina = resultados_finais.filter(x => x < capital_investido).length;

            const prob_sucesso = (sucesso / n_simulacoes * 100).toFixed(2);
            const prob_ruina = (ruina / n_simulacoes * 100).toFixed(2);

            // Value at Risk: m√°xima perda esperada (5¬∫ percentil)
            const var_95 = capital_investido - saldo_minimo;

            return {
                saldo_minimo,
                saldo_mediano,
                saldo_medio,
                saldo_maximo,
                desvio_resultados,
                prob_sucesso,
                prob_ruina,
                var_95,
                resultados_finais,
                historico_evolucao,
                capital_investido,
                meta_final
            };
        }

        /**
         * Formata valor monet√°rio em reais
         */
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        /**
         * Formata porcentagem
         */
        function formatarPorcentagem(valor) {
            return (valor).toFixed(2) + '%';
        }

        /**
         * Renderiza gr√°fico de evolu√ß√£o
         */
        function renderizarGraficoEvolucao(historico_evolucao, periodo_anos) {
            const ctx = document.getElementById('chart_evolucao').getContext('2d');
            
            // Preparar dados para visualizar apenas alguns percentis (para n√£o poluir)
            const meses_intervalo = Math.ceil((periodo_anos * 12) / 12); // Mostrar anualmente
            const labels = [];
            const dados_media = [];
            const dados_p95 = [];
            const dados_p5 = [];

            for (let mes = 0; mes <= periodo_anos * 12; mes += 12) {
                if (historico_evolucao[mes] && historico_evolucao[mes].length > 0) {
                    const valores = historico_evolucao[mes].sort((a, b) => a - b);
                    const ano = Math.round(mes / 12);
                    labels.push(`Ano ${ano}`);
                    
                    const media = valores.reduce((a, b) => a + b) / valores.length;
                    const p95 = valores[Math.floor(valores.length * 0.95)];
                    const p5 = valores[Math.floor(valores.length * 0.05)];
                    
                    dados_media.push(media);
                    dados_p95.push(p95);
                    dados_p5.push(p5);
                }
            }

            if (chartEvolucao) {
                chartEvolucao.destroy();
            }

            chartEvolucao = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'M√©dia (50¬∫ percentil)',
                            data: dados_media,
                            borderColor: '#d4633f',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Cen√°rio Otimista (95¬∫ percentil)',
                            data: dados_p95,
                            borderColor: '#218014',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Cen√°rio Pessimista (5¬∫ percentil)',
                            data: dados_p5,
                            borderColor: '#c01547',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Intervalo de Confian√ßa (5%-95%)',
                            data: dados_p95.map((val, i) => ({x: i, y: val})),
                            type: 'scatter',
                            fill: '-1',
                            backgroundColor: 'rgba(33, 88, 165, 0.1)',
                            pointRadius: 0,
                            borderColor: 'transparent'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        filler: {
                            propagate: true
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renderiza histograma dos saldos finais
         */
        function renderizarGraficoDistribuicao(resultados_finais, meta_final) {
            const ctx = document.getElementById('chart_distribuicao').getContext('2d');
            
            // Criar bins para histograma
            const min = Math.min(...resultados_finais);
            const max = Math.max(...resultados_finais);
            const n_bins = 30;
            const bin_width = (max - min) / n_bins;
            
            const bins = Array(n_bins).fill(0);
            const labels = [];
            
            for (let i = 0; i < n_bins; i++) {
                const bin_start = min + i * bin_width;
                const bin_end = bin_start + bin_width;
                labels.push((bin_start / 1000000).toFixed(1) + 'M');
                
                bins[i] = resultados_finais.filter(x => x >= bin_start && x < bin_end).length;
            }

            if (chartDistribuicao) {
                chartDistribuicao.destroy();
            }

            chartDistribuicao = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequ√™ncia',
                        data: bins,
                        backgroundColor: 'rgba(33, 88, 165, 0.6)',
                        borderColor: '#2158a5',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + ' cen√°rios';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Popula tabela de proje√ß√£o anual
         */
        function preencherTabelaProjecao(historico_evolucao, periodo_anos, capital_inicial, aporte_mensal) {
            const tbody = document.getElementById('tabela_body');
            tbody.innerHTML = '';

            const n_simulacoes = historico_evolucao[0].length;

            for (let ano = 0; ano <= periodo_anos; ano++) {
                const mes = ano * 12;
                
                if (!historico_evolucao[mes]) continue;

                const valores = historico_evolucao[mes].sort((a, b) => a - b);
                const total_investido = capital_inicial + (aporte_mensal * mes);
                const media = valores.reduce((a, b) => a + b) / n_simulacoes;
                const p5 = valores[Math.floor(n_simulacoes * 0.05)];
                const p50 = valores[Math.floor(n_simulacoes * 0.5)];
                const p95 = valores[Math.floor(n_simulacoes * 0.95)];

                const row = `
                    <tr>
                        <td><strong>Ano ${ano}</strong></td>
                        <td>${formatarMoeda(total_investido)}</td>
                        <td>${formatarMoeda(media)}</td>
                        <td style="color: #c01547;">${formatarMoeda(p5)}</td>
                        <td style="color: #d4633f;">${formatarMoeda(p50)}</td>
                        <td style="color: #218014;">${formatarMoeda(p95)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        }

        /**
         * FUN√á√ÉO DISPARADORA: Executa toda a simula√ß√£o
         */
        function executarSimulacao() {
            // Obter valores do formul√°rio
            const capital_inicial = parseFloat(document.getElementById('capital_inicial').value);
            const aporte_mensal = parseFloat(document.getElementById('aporte_mensal').value);
            const media_retorno = parseFloat(document.getElementById('media_retorno').value);
            const volatilidade = parseFloat(document.getElementById('volatilidade').value);
            const periodo_anos = parseInt(document.getElementById('periodo_anos').value);
            const n_simulacoes = parseInt(document.getElementById('n_simulacoes').value);
            const metodo = document.getElementById('metodo_simulacao').value;
            const meta_final = parseFloat(document.getElementById('meta_final').value);

            // Mostrar loading
            const status = document.getElementById('status_simulacao');
            status.innerHTML = '<div class="loading"></div> Executando ' + n_simulacoes.toLocaleString() + ' simula√ß√µes...';

            // Executar no setTimeout para permitir que a UI atualize
            setTimeout(() => {
                try {
                    // Executar simula√ß√£o
                    simulacaoAtual = executarMonteCarlo({
                        capital_inicial,
                        aporte_mensal,
                        media_retorno,
                        volatilidade,
                        periodo_anos,
                        n_simulacoes,
                        metodo,
                        meta_final
                    });

                    // Atualizar cards de resultado
                    document.getElementById('resultados_container').style.display = 'grid';
                    document.getElementById('saldo_final_medio').textContent = formatarMoeda(simulacaoAtual.saldo_medio);
                    document.getElementById('saldo_mediano').textContent = formatarMoeda(simulacaoAtual.saldo_mediano);
                    document.getElementById('saldo_maximo').textContent = formatarMoeda(simulacaoAtual.saldo_maximo);
                    document.getElementById('saldo_minimo').textContent = formatarMoeda(simulacaoAtual.saldo_minimo);

                    const ganho_percentual = ((simulacaoAtual.saldo_medio - simulacaoAtual.capital_investido) / simulacaoAtual.capital_investido * 100).toFixed(2);
                    document.getElementById('saldo_percentual').textContent = `Ganho: ${ganho_percentual}%`;

                    // Mostrar gr√°ficos
                    document.getElementById('chart_card_1').style.display = 'block';
                    document.getElementById('chart_card_2').style.display = 'block';
                    document.getElementById('table_card').style.display = 'block';
                    document.getElementById('risk_card').style.display = 'block';

                    // Renderizar gr√°ficos
                    renderizarGraficoEvolucao(simulacaoAtual.historico_evolucao, periodo_anos);
                    renderizarGraficoDistribuicao(simulacaoAtual.resultados_finais, meta_final);

                    // Preencher tabela
                    preencherTabelaProjecao(simulacaoAtual.historico_evolucao, periodo_anos, capital_inicial, aporte_mensal);

                    // Atualizar m√©tricas de risco
                    document.getElementById('prob_sucesso').textContent = simulacaoAtual.prob_sucesso + '%';
                    document.getElementById('prob_ruina').textContent = simulacaoAtual.prob_ruina + '%';
                    document.getElementById('var_95').textContent = formatarMoeda(simulacaoAtual.var_95);
                    document.getElementById('volatilidade_resultados').textContent = formatarMoeda(simulacaoAtual.desvio_resultados);

                    status.innerHTML = '‚úÖ Simula√ß√£o conclu√≠da com sucesso!';
                } catch (erro) {
                    status.innerHTML = '‚ùå Erro: ' + erro.message;
                    console.error(erro);
                }
            }, 100);
        }

        /**
         * Limpa todos os resultados
         */
        function limparResultados() {
            document.getElementById('resultados_container').style.display = 'none';
            document.getElementById('chart_card_1').style.display = 'none';
            document.getElementById('chart_card_2').style.display = 'none';
            document.getElementById('table_card').style.display = 'none';
            document.getElementById('risk_card').style.display = 'none';
            document.getElementById('status_simulacao').innerHTML = '';
            simulacaoAtual = null;
        }

        // Permitir executar com Enter
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    executarSimulacao();
                }
            });
        });
    </script>
</body>
</html>
